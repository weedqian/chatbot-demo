var U=Object.defineProperty;var H=(n,t,s)=>t in n?U(n,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):n[t]=s;var b=(n,t,s)=>H(n,typeof t!="symbol"?t+"":t,s);import{R as h,j as e}from"./index-BgkUANsO.js";import{S,i as T,C as V,s as y,R as I,u as f,L as d,r as i,E as C,a as w,H as k,v as D,b as G,P as $,c as R,d as q,e as W,f as z}from"./pipeline-C11NUhXX.js";const _=new Set,F=new S([],{equals:T}),J=V.fromObservables([F],([n])=>n.filter(t=>_.has(t.id),{equals:T})),X={$chatgptTabs:F,$chatgptTabsOpenedByExtensions:J,$settings:new S(y.defaults(),{equals:T}),openedChatgptTabIds:_};new I({name:"wulala.server",date:!0,getLevel:()=>X.$settings.getSnapshot().loglevel});const O="@/storage/server-settings",P={fetchSettings:async()=>new Promise(n=>{try{chrome.storage.local.get(O,t=>{try{const s=t[O]||"{}",r=JSON.parse(s),o=y.normalize(r);n(o)}catch{n(y.defaults())}})}catch{n(y.defaults())}}),updateSettings:async n=>{const t=JSON.stringify(n);chrome.storage.local.set({[O]:t},()=>{})}},N=({name:n,value:t,minimum:s,maximum:r,onChange:o})=>{const[a,u]=h.useState(String(t)),[l,c]=h.useState(""),x=h.useId(),E=f(m=>{const p=m.target.value||"";u(p),c("")}),g=f(()=>{if(!a){u(""),c("Cannot be empty");return}const m=Number.parseFloat(a);if(isNaN(m)){c("Please enter a valid number");return}if(s!==void 0&&m<s){c(`Value must be at least ${s}`);return}if(r!==void 0&&m>r){c(`Value must be at most ${r}`);return}c(""),u(a),o(m)});return e.jsxs("div",{className:"flex w-full flex-col p-2",children:[e.jsxs("div",{className:"flex w-full flex-row items-center justify-center",children:[e.jsxs("label",{htmlFor:x,className:"mr-2 flex w-56 flex-initial justify-end",children:[n,":"]}),e.jsx("input",{type:"number",id:x,value:a,onChange:E,onBlur:g,className:"mt-1 block flex-auto rounded-md border-gray-300 p-2 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200"})]}),l&&e.jsx("p",{className:"mt-2 text-sm text-red-500",children:l})]})};function A(n){const{label:t,options:s,value:r,onChange:o}=n;return e.jsxs("div",{className:"flex w-full max-w-xs items-center gap-4",children:[e.jsx("label",{className:"mb-1 block flex-initial text-sm font-medium text-gray-700",children:t}),e.jsxs("div",{className:"relative flex-auto",children:[e.jsx("select",{value:r,onChange:a=>o(a.target.value),className:"block w-full appearance-none rounded border border-gray-300 bg-white px-4 py-2 pr-8 leading-tight shadow hover:border-gray-400 focus:outline-none",children:s.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))}),e.jsx("div",{className:"pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700",children:e.jsx("svg",{className:"size-4 fill-current",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",children:e.jsx("path",{d:"M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"})})})]})]})}const K=({name:n,value:t,onChange:s})=>{const r=h.useId(),[o,a]=h.useState(t),u=f(c=>{const x=c.target.value||"";a(x)}),l=f(()=>{o!==t&&s(o)});return h.useEffect(()=>{a(t)},[t]),e.jsx("div",{className:"flex w-full flex-col p-2",children:e.jsxs("div",{className:"flex w-full flex-row items-center justify-center",children:[e.jsxs("label",{htmlFor:r,className:"mr-2 flex w-56 flex-initial justify-end",children:[n,":"]}),e.jsx("input",{type:"text",id:r,value:o,onChange:u,onBlur:l,className:"mt-1 block w-full rounded-md border-gray-300 p-2 shadow-sm transition duration-150 ease-in-out focus:border-indigo-500 focus:ring focus:ring-indigo-200"})]})})},Y=[{label:d.DEBUG,value:d.DEBUG},{label:d.VERBOSE,value:d.VERBOSE},{label:d.INFO,value:d.INFO},{label:d.WARN,value:d.WARN},{label:d.ERROR,value:d.ERROR}],Q=n=>{const{settings:t,onSettingsChange:s}=n,[r,o]=h.useState(!1),[a,u]=h.useState(!0),[l,c]=h.useState(!0),[x,E]=h.useState(!0);return e.jsx(i.Card,{className:"my-4 w-full max-w-[40rem] flex-auto",children:e.jsxs(i.CardBody,{children:[e.jsx("h1",{className:"mb-4 text-2xl font-bold",children:"ChatGPT Page Settings"}),e.jsx("form",{children:e.jsx("div",{className:"mb-4 flex items-center justify-start",children:e.jsx(A,{label:"loglevel",value:t.loglevel,options:Y,onChange:g=>{s({...t,loglevel:g})}})})}),e.jsxs(i.Accordion,{open:r,children:[e.jsx(i.AccordionHeader,{onClick:()=>o(g=>!g),children:e.jsx("h2",{className:"mb-4 text-lg font-bold",children:"Advanced Settings"})}),e.jsxs(i.AccordionBody,{children:[e.jsxs(i.Accordion,{open:a,children:[e.jsx(i.AccordionHeader,{onClick:()=>u(g=>!g),children:e.jsx("h3",{className:"mb-4 text-base font-bold",children:"selector"})}),e.jsx(i.AccordionBody,{children:e.jsxs("form",{className:"w-full rounded-lg bg-white p-6 shadow-md",children:[...Object.entries(t.selectors).map(([g,m])=>e.jsx(K,{name:g,value:m,onChange:p=>{s({...t,selectors:{...t.selectors,[g]:p}})}}))]})})]}),e.jsxs(i.Accordion,{open:l,children:[e.jsx(i.AccordionHeader,{onClick:()=>c(g=>!g),children:e.jsx("h3",{className:"mb-4 text-base font-bold",children:"delay"})}),e.jsx(i.AccordionBody,{children:e.jsxs("form",{className:"w-full rounded-lg bg-white p-6 shadow-md",children:[...Object.entries(t.delay).map(([g,m])=>e.jsx(N,{name:g,value:m,onChange:p=>{s({...t,delay:{...t.delay,[g]:p}})}}))]})})]}),e.jsxs(i.Accordion,{open:x,children:[e.jsx(i.AccordionHeader,{onClick:()=>E(g=>!g),children:e.jsx("h3",{className:"mb-4 text-base font-bold",children:"timeout"})}),e.jsx(i.AccordionBody,{children:e.jsxs("form",{className:"w-full rounded-lg bg-white p-6 shadow-md",children:[...Object.entries(t.timeout).map(([g,m])=>e.jsx(N,{name:g,value:m,onChange:p=>{s({...t,timeout:{...t.timeout,[g]:p}})}}))]})})]})]})]})]})})},Z=[{label:d.DEBUG,value:d.DEBUG},{label:d.VERBOSE,value:d.VERBOSE},{label:d.INFO,value:d.INFO},{label:d.WARN,value:d.WARN},{label:d.ERROR,value:d.ERROR}],ee=n=>{const{settings:t,onSettingsChange:s}=n,[r,o]=h.useState(!1),[a,u]=h.useState(!0);return e.jsx(i.Card,{className:"my-4 w-full max-w-[40rem] flex-auto",children:e.jsxs(i.CardBody,{children:[e.jsx("h1",{className:"mb-4 text-2xl font-bold",children:"SBS Page Settings"}),e.jsx("form",{children:e.jsx("div",{className:"mb-4 flex items-center justify-start",children:e.jsx(A,{label:"loglevel",value:t.loglevel,options:Z,onChange:l=>{s({...t,loglevel:l})}})})}),e.jsxs(i.Accordion,{open:r,children:[e.jsx(i.AccordionHeader,{onClick:()=>o(l=>!l),children:e.jsx("h2",{className:"mb-4 text-lg font-bold",children:"Advanced Settings"})}),e.jsx(i.AccordionBody,{children:e.jsxs(i.Accordion,{open:a,children:[e.jsx(i.AccordionHeader,{onClick:()=>u(l=>!l),children:e.jsx("h3",{className:"mb-4 text-base font-bold",children:"delay"})}),e.jsx(i.AccordionBody,{children:e.jsxs("form",{className:"w-full rounded-lg bg-white p-6 shadow-md",children:[...Object.entries(t.delay).map(([l,c])=>e.jsx(N,{name:l,value:c,onChange:x=>{s({...t,delay:{...t.delay,[l]:x}})}}))]})})]})})]})]})})},te=[{label:d.DEBUG,value:d.DEBUG},{label:d.VERBOSE,value:d.VERBOSE},{label:d.INFO,value:d.INFO},{label:d.WARN,value:d.WARN},{label:d.ERROR,value:d.ERROR}],se=n=>{const{settings:t,onSettingsChange:s}=n,[r,o]=h.useState(!1),[a,u]=h.useState(!0);return e.jsx(i.Card,{className:"my-4 w-full max-w-[40rem] flex-auto",children:e.jsxs(i.CardBody,{children:[e.jsx("h1",{className:"mb-4 text-2xl font-bold",children:"Extension Server Settings"}),e.jsxs("form",{children:[e.jsx("div",{className:"mb-4 flex items-center justify-start",children:e.jsx(A,{label:"loglevel",value:t.loglevel,options:te,onChange:l=>{s({...t,loglevel:l})}})}),e.jsx("div",{className:"mb-4 flex items-center justify-start",children:e.jsx(i.Checkbox,{label:"logheartbeat",checked:t.logheartbeat,onChange:()=>{s({...t,logheartbeat:!t.logheartbeat})}})})]}),e.jsxs(i.Accordion,{open:r,children:[e.jsx(i.AccordionHeader,{onClick:()=>o(l=>!l),children:e.jsx("h2",{className:"mb-4 text-lg font-bold",children:"Advanced Settings"})}),e.jsx(i.AccordionBody,{children:e.jsxs(i.Accordion,{open:a,children:[e.jsx(i.AccordionHeader,{onClick:()=>u(l=>!l),children:e.jsx("h3",{className:"mb-4 text-base font-bold",children:"delay"})}),e.jsx(i.AccordionBody,{children:e.jsxs("form",{className:"w-full rounded-lg bg-white p-6 shadow-md",children:[...Object.entries(t.delay).map(([l,c])=>e.jsx(N,{name:l,value:c,onChange:x=>{s({...t,delay:{...t.delay,[l]:x}})}}))]})})]})})]})]})})},ne=()=>{const[n,t]=h.useState(!0),[s,r]=h.useState(()=>y.defaults()),o=f(c=>{r(c),P.updateSettings(c)}),a=f(c=>{const x={...s,chatgpt:c};o(x)}),u=f(c=>{const x={...s,localhost:c};o(x)}),l=f(c=>{const x={...s,...c};o(x)});return h.useEffect(()=>{let c=!1;return P.fetchSettings().then(x=>{c||(r(x),t(!1))}),()=>{c=!0}},[]),n?e.jsx("div",{children:e.jsx("span",{children:"loading..."})}):e.jsxs("div",{className:"flex flex-col items-center gap-4 p-2",children:[e.jsx(se,{settings:s,onSettingsChange:l}),e.jsx(Q,{settings:s.chatgpt,onSettingsChange:a}),e.jsx(ee,{settings:s.localhost,onSettingsChange:u})]})};class ae{constructor(t){b(this,"from");b(this,"name");b(this,"passthrough");b(this,"reporter");b(this,"onmessage");b(this,"_port");const{from:s,name:r,passthrough:o,reporter:a,onmessage:u}=t;this.from=s,this.name=r,this.passthrough=o,this.reporter=a,this.onmessage=u,this._port=null}watch_reconnect(){const{reporter:t}=this;chrome.runtime.onMessage.addListener(s=>{if(s.from===C.SERVER)switch(t.debug(`--> ${s.from} - ${s.type}:`,{message:s}),s.type){case w.RECONNECT:{this.connect(!0);break}default:t.error("Unknown message:",s)}})}connect(t){const{name:s,passthrough:r,reporter:o,onmessage:a}=this;if(this._port){if(!t)return this._port;try{this._port.disconnect()}catch(l){o.error("Failed to disconnect. error:",l)}this._port=null}const u=chrome.runtime.connect(void 0,{name:s});return u.onDisconnect.addListener(()=>{o.info(`Port ${u.name} disconnected.`),this._port=null}),u.onMessage.addListener(l=>{o.debug(`--> ${l.from} - ${l.type}:`,{pack:l}),a&&a(l),r&&window.postMessage({action:k.FROM_EXTENSION_CONTEXT,payload:l},"*")}),o.info("connect on port:",u.name),this._port=u,u}heartbeat(t){const{from:s}=this,r={mid:D(),index:0,total:1,from:s,type:w.HEARTBEAT,payload:JSON.stringify({uuid:t})};this.send(r)}send(t){const{reporter:s}=this,r=this.connect(!1);try{r.postMessage(t)}catch(o){s.error("Failed to send pack:",{pack:t,error:o}),s.info("Trying to reconnect..."),this.connect(!0).postMessage(t)}}}const M={port:"popup",fetchChatgptTabs:"popup.fetchChatgptTabs",fetchOpenedChatgptTabs:"popup.fetchOpenedChatgptTabs"},v=new I({name:"wulala.popup",date:!0,getLevel:()=>d.DEBUG}),L=new ae({from:C.POPUP,name:M.port,passthrough:!1,reporter:v,onmessage:n=>{if(typeof n.mid!="string"||typeof n.type!="string"||!G.has(n.type)){v.error("Unknown event from dom context:",{pack:n});return}B.receive(n)}});L.watch_reconnect();const B=new $({from:C.POPUP,reporter:v,writeMessagePack:async n=>{L.send(n)},handleMessage:async n=>{const t=n,s=j.get(t.uuid);if(!s){v.error("Cannot find the state with the given uuid:",{message:t});return}switch(t.code){case R.SUCCEED:{s.next({loading:!1,code:t.code,data:t.data,error:null});break}case R.FAILED:{v.error("Request failed:",{message:t}),s.next({loading:!1,code:t.code,data:null,error:t.error??null});break}default:v.error("Invalid message:",{message:t});break}}}),j=new Map,le=n=>{const t=D(),s=(j.has(t)||j.set(t,new S({loading:!1,code:null,data:null,error:null})),j.get(t)),r={uuid:t,from:C.POPUP,type:n.type,data:n.data};return B.write(r),s.next({loading:!0,code:null,data:null,error:null}),s},oe=n=>{const t=h.useMemo(()=>(j.has(n)||j.set(n,new S({loading:!1,code:null,data:null,error:null})),j.get(n)),[n]),s=h.useCallback(r=>{const o={uuid:n,from:C.POPUP,type:r.type,data:r.data};return B.write(o),t.next({loading:!0,code:null,data:null,error:null}),t},[t,n]);return{state:t,request:s}},re=n=>{const{state:t,request:s}=oe(M.fetchOpenedChatgptTabs),{loading:r,code:o,data:a,error:u}=q(t),l=h.useCallback(()=>{s({type:w.FETCH_CHATGPT_TABS,data:{filter:n}})},[s,n]);h.useEffect(()=>{l()},[l]);const c=(a==null?void 0:a.tabs)??[];return{loading:r,code:o,tabs:c,error:u,refresh:l}},ce=()=>h.useCallback(t=>{const s=le({type:w.CLOSE_CHATGPT_TAB,data:{tabid:t}});return new Promise((r,o)=>{let a=!1;const u=c=>{a||(a=!0,r(c))},l=c=>{a||(a=!0,o(c))};s.subscribe(new W({onNext:c=>{c.error?l(c.error):c.code===R.SUCCEED?u(!0):u(!1)},onDispose:()=>l("[useCloseChatgptTab] The state has been disposed.")}))})},[]),ie=()=>{const{tabs:n,refresh:t}=re("openedByExtension"),s=ce(),r=f(o=>{s(o).then(()=>t()).catch(a=>console.error("Failed to close tab",a))});return e.jsx("div",{className:"flex w-full flex-col items-center gap-4 p-2",children:e.jsx(i.Card,{className:"my-4 w-full max-w-[40rem] flex-auto",children:e.jsxs(i.CardBody,{children:[e.jsx("h1",{className:"mb-4 text-2xl font-bold",children:"ChatGPT Tabs"}),e.jsx("div",{className:"w-full",children:n.length>0?e.jsxs(i.List,{children:[...n.map(o=>e.jsxs(i.ListItem,{className:"flex justify-between",children:[e.jsxs("div",{className:"flex flex-auto gap-4",children:[e.jsx("span",{children:o.id}),e.jsx("span",{children:o.title})]}),e.jsx("button",{className:"flex-auto",onClick:a=>{a.stopPropagation(),a.preventDefault(),r(o.id)},children:e.jsx(z,{})})]}))]}):e.jsx("div",{className:"flex w-full justify-start",children:"Empty"})})]})})})},de=()=>e.jsxs("div",{className:"size-full bg-gray-50",children:[e.jsx("div",{className:"flex w-full flex-col gap-4",children:e.jsx(ie,{})}),e.jsx("div",{className:"flex w-full flex-col gap-4",children:e.jsx(ne,{})})]});de.displayName="PopupPage";export{de as default};
